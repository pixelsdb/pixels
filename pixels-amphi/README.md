# Pixels Amphi

`Pixels-Amphi` is the query coordinator in Pixels that aims at improving flexibility and cost-efficiency of
query processing.
It serves as an adaptive framework to leverage the on-premises resources and allocate 
compute workload more cost-efficiently.

## Components

Currently, `Pixels-Amphi` uses Trino as the query entry-point and the query processor in the cloud,
and use DuckDB as the engine for the local worker. The server-client communication is implemented with gRPC.
`Pixels-Amphi` is composed of the following two components:
- [`pixels-amphi`](./pixels-amphi) works inside the `pixels-server` to provide coordinating decision. 
Coordinator analyzes the SQL query and decides if the worker has cached the data required to execute the query.
- [`pixels-amphi-worker`](./pixels-amphi-worker) is an independent client process to handle with the OLAP workload.
Given the workload, the worker will download partial columns data in the storage first. 
Then it submits the query to pixels server endpoint and processes the coordinator response.

## Usage

On the server side, install `Pixels + Trino` following the instructions [HERE](../docs/INSTALL.md).

On the worker/client side, build `pixels-amphi-worker` from source or build a Docker container. 
See the instructions [HERE](./pixels-amphi-worker/README.md).

### Custom schema

`pixels-amphi` uses `Apache Avro` to specify the schema and uses `avro-parquet` as the parquet file writer.
Before downloading the partial data into the local storage, make sure that the schema has been specified in the
[schema folder](./pixels-amphi/src/main/resources/schema).

First create a folder with the schema name (e.g., `tpch`, `clickbench`), then create the avsc files for each table.
Remember to register the path in `schemas.txt` so that `PartialSchemaLoader` is aware of them.

Note that avro schema does not have built-in type for some SQL type like `decimal`, `date`, `timestamp`.
They have to be converted to other types and claimed as `logicalType` in avsc files. For example:

````
// decimal type
    {
      "name": "l_tax",
      "type": {
        "type": "bytes",
        "logicalType": "decimal",
        "precision": 15,
        "scale": 2
      }
    }
    
// date type
    {
      "name": "l_shipdate",
      "type": {
        "type": "int",
        "logicalType": "date"
      }
    }
    
// timestamp type
    {
      "name": "EventTime",
      "type": {
        "type": "long",
        "logicalType": "timestamp-millis"
      }
    }
````

### Download partial data

To leverage on-premises resources, the worker first analyze the workload and then download from s3 storage to 
parquet files in the local storage.

After building the pixels project with `mvn clean install`, you will find `pixels-amphi-*.jar` in the target folder
of [`pixels-amphi`](./pixels-amphi). It accepts the configuration file as the command parameter.
Refer to the [example](./pixels-amphi/src/test/resources/config/tpch.json) in the test folder.
The configuration file can be either manually specified but usually automatically 
generated by the workload distribution algorithm script. 
The algorithm can plan optimally for the columns to cache to improve cost-efficiency.

## Benchmark
